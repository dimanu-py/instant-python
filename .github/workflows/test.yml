name: Run lint, format and tests

on:
  push:
    branches:
      - main

permissions:
  contents: write
  id-token: write

jobs:

  test:
    name: test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›¡ï¸ Harden runner
        uses: step-security/harden-runner@6c439dc8bdf85cadbbce9ed30d1c7b959517bc49 # v2.12.2
        with:
          egress-policy: audit

      - name: ğŸ“¥ Checkout the repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: ğŸ› ï¸ Setup environment
        uses: ./.github/actions/python_setup

      - name: ğŸ“¦ Install test dependencies
        run: uv pip install pytest pytest-cov

      - name: ğŸƒ Run tests
        run: uv run pytest --cov --cov-report=xml --cov-branch test -ra -s

      - name: ğŸ“¥ Upload coverage report to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: coverage.xml
          flags: unittests
          name: codecov-coverage

  rollback:
    name: rollback
    runs-on: ubuntu-latest
    needs: [test]
    if: ${{ always() && needs.test.result == 'failure' }}
    steps:
      - name: ğŸ›¡ï¸ Harden runner
        uses: step-security/harden-runner@6c439dc8bdf85cadbbce9ed30d1c7b959517bc49 # v2.12.2
        with:
          egress-policy: audit

      - name: ğŸ“¥ Checkout the repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: âªï¸ Reset to previous commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git reset --hard ${{ github.event.before }}
          git push --force-with-lease origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
